generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Organization {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  document      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users            User[]
  clients          Client[]
  deals            Deal[]
  projects         Project[]
  financialRecords FinancialRecord[]

  leads            Lead[]

  products         Product[]

  type          OrgType  @default(SERVICE)

  sales             Sale[]
  
  @@map("organizations")
}


model User {
  id             String   @id @default(uuid())
  name           String
  email          String   @unique
  password_hash  String
  role           Role     @default(MEMBER)
  avatarUrl      String?
  
  // Decimal exige precisão no Postgres (10 digitos, 2 casas decimais)
  hourlyRate     Decimal  @default(0.00) @db.Decimal(10, 2) 

  resetToken        String?   @unique // O código secreto
  resetTokenExpires DateTime? // Validade do código

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  assignedDeals    Deal[]
  assignedProjects Project[]
  timeLogs         TimeLog[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@map("users")
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  OBSERVER
}


model Client {
  id             String   @id @default(uuid())
  name           String
  contactName    String?
  email          String?
  phone          String?
  document       String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  deals            Deal[]
  projects         Project[]
  financialRecords FinancialRecord[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  porcentagemDesconto Float @default(0)
  sales               Sale[]

  @@index([organizationId])
  @@map("clients")
}


model Deal {
  id          String     @id @default(uuid())
  title       String
  value       Decimal    @db.Decimal(15, 2) // Dinheiro
  status      DealStatus @default(OPEN)
  probability Int?       
  
  expectedCloseDate DateTime?

  clientId       String
  client         Client @relation(fields: [clientId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  assignedToId   String?
  assignedTo     User?   @relation(fields: [assignedToId], references: [id])

  generatedProjectId String? @unique
  generatedProject   Project? @relation(fields: [generatedProjectId], references: [id])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  order Int      @default(0)

  @@index([organizationId])
  @@map("deals")

}

enum DealStatus {
  OPEN
  WON
  LOST
}

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)
  
  totalBudget Decimal       @db.Decimal(15, 2) // Dinheiro
  
  startDate   DateTime?
  endDate     DateTime?

  shareToken  String?       @unique

  clientId       String
  client         Client @relation(fields: [clientId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  managerId      String?
  manager        User?   @relation(fields: [managerId], references: [id])

  originDeal     Deal?
  tasks          Task[]
  financialRecords FinancialRecord[]
  timeLogs         TimeLog[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@map("projects")
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELED
}

model Task {
  id          String   @id @default(uuid())
  title       String
  description String?
  isCompleted Boolean  @default(false)

  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  timeLogs    TimeLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tasks")
}


model FinancialRecord {
  id          String        @id @default(uuid())
  type        RecordType
  amount      Decimal       @db.Decimal(15, 2) // Dinheiro
  date        DateTime
  description String
  status      PaymentStatus @default(PENDING)
  category    String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])

  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([organizationId])
  @@index([projectId])
  @@map("financial_records")
}

model TimeLog {
  id          String   @id @default(uuid())
  startTime   DateTime
  endTime     DateTime?
  durationMinutes Int?
  description String?
  
  costRateSnapshot Decimal @db.Decimal(10, 2) 

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])

  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("time_logs")
}

enum RecordType {
  INCOME
  EXPENSE
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELED
}

model Lead {
  id          String     @id @default(uuid())
  title       String     // Ex: "Site da Padaria"
  contactName String     // Ex: "Sr. João"
  email       String?
  phone       String?
  value       Decimal?   @db.Decimal(15, 2) // Valor estimado
  status      LeadStatus @default(NEW)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([organizationId])
  @@map("leads")
}

// AS COLUNAS DO KANBAN
enum LeadStatus {
  NEW         // Novo Lead
  CONTACT     // Contato Feito
  PROPOSAL    // Proposta Enviada
  WON         // Ganho (Vira Cliente)
  LOST        // Perdido
}


enum ProductType {
  GOOD     // Produto Físico (Shampoo, Camiseta) - Controla Estoque
  SERVICE  // Serviço (Corte, Consultoria) - Não tem estoque
}

// CATÁLOGO DE ITENS
model Product {
  id          String      @id @default(uuid())
  name        String
  description String?
  price       Decimal     @db.Decimal(10, 2) // Preço de Venda
  costPrice   Decimal?    @db.Decimal(10, 2) // Preço de Custo (Opcional, pra saber margem)
  
  type        ProductType @default(GOOD)
  
  // Controle de Estoque
  stockQuantity Int       @default(0) // Quantidade atual
  minStock      Int?      @default(0) // Estoque mínimo (pra avisar quando tá acabando)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  estoqueMinimo Int @default(5)
  saleItems     SaleItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([organizationId])
  @@map("products")
}

enum OrgType {
  SERVICE  // Agências, Consultorias (Foco: Projetos + CRM)
  RETAIL   // Comércio, Barbearias (Foco: PDV + Estoque)
  HYBRID   // (Futuro: Faz os dois)
}


enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PIX
  CASH
}

// A Venda em si (Cabeçalho do Recibo)
model Sale {
  id             String        @id @default(uuid())
  code           Int           @default(autoincrement()) // Código numérico para o recibo (Ex: Venda #105)
  
  total          Decimal       @db.Decimal(10, 2)
  discount       Decimal?      @db.Decimal(10, 2) // Valor do desconto aplicado
  
  paymentMethod  PaymentMethod @default(CASH)
  installments   Int           @default(1) // Quantidade de parcelas (ex: 3)
  
  // Relacionamentos
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id])
  
  clientId       String?
  client         Client?       @relation(fields: [clientId], references: [id])

  items          SaleItem[] // Os produtos dessa venda

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("sales")
}

// Os Itens da Venda (Linhas do Recibo)
model SaleItem {
  id        String  @id @default(uuid())
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2) // Preço na hora da venda (se mudar depois, esse não muda)
  total     Decimal @db.Decimal(10, 2) // quantity * unitPrice
  
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@map("sale_items")
}