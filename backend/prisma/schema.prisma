generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Organization {
  id            String   @id @default(uuid())
  name          String
  slug          String   @unique
  document      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users            User[]
  clients          Client[]
  deals            Deal[]
  projects         Project[]
  financialRecords FinancialRecord[]

  leads            Lead[]
  
  @@map("organizations")
}


model User {
  id             String   @id @default(uuid())
  name           String
  email          String   @unique
  password_hash  String
  role           Role     @default(MEMBER)
  avatarUrl      String?
  
  // Decimal exige precis찾o no Postgres (10 digitos, 2 casas decimais)
  hourlyRate     Decimal  @default(0.00) @db.Decimal(10, 2) 

  resetToken        String?   @unique // O c처digo secreto
  resetTokenExpires DateTime? // Validade do c처digo

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  assignedDeals    Deal[]
  assignedProjects Project[]
  timeLogs         TimeLog[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@map("users")
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  OBSERVER
}


model Client {
  id             String   @id @default(uuid())
  name           String
  contactName    String?
  email          String?
  phone          String?
  document       String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  deals            Deal[]
  projects         Project[]
  financialRecords FinancialRecord[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@map("clients")
}


model Deal {
  id          String     @id @default(uuid())
  title       String
  value       Decimal    @db.Decimal(15, 2) // Dinheiro
  status      DealStatus @default(OPEN)
  probability Int?       
  
  expectedCloseDate DateTime?

  clientId       String
  client         Client @relation(fields: [clientId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  assignedToId   String?
  assignedTo     User?   @relation(fields: [assignedToId], references: [id])

  generatedProjectId String? @unique
  generatedProject   Project? @relation(fields: [generatedProjectId], references: [id])

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@map("deals")
}

enum DealStatus {
  OPEN
  WON
  LOST
}

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)
  
  totalBudget Decimal       @db.Decimal(15, 2) // Dinheiro
  
  startDate   DateTime?
  endDate     DateTime?

  shareToken  String?       @unique

  clientId       String
  client         Client @relation(fields: [clientId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  managerId      String?
  manager        User?   @relation(fields: [managerId], references: [id])

  originDeal     Deal?
  tasks          Task[]
  financialRecords FinancialRecord[]
  timeLogs         TimeLog[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@map("projects")
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELED
}

model Task {
  id          String   @id @default(uuid())
  title       String
  description String?
  isCompleted Boolean  @default(false)

  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  timeLogs    TimeLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tasks")
}


model FinancialRecord {
  id          String        @id @default(uuid())
  type        RecordType
  amount      Decimal       @db.Decimal(15, 2) // Dinheiro
  date        DateTime
  description String
  status      PaymentStatus @default(PENDING)
  category    String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])

  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([organizationId])
  @@index([projectId])
  @@map("financial_records")
}

model TimeLog {
  id          String   @id @default(uuid())
  startTime   DateTime
  endTime     DateTime?
  durationMinutes Int?
  description String?
  
  costRateSnapshot Decimal @db.Decimal(10, 2) 

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])

  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("time_logs")
}

enum RecordType {
  INCOME
  EXPENSE
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELED
}

model Lead {
  id          String     @id @default(uuid())
  title       String     // Ex: "Site da Padaria"
  contactName String     // Ex: "Sr. Jo찾o"
  email       String?
  phone       String?
  value       Decimal?   @db.Decimal(15, 2) // Valor estimado
  status      LeadStatus @default(NEW)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([organizationId])
  @@map("leads")
}

// AS COLUNAS DO KANBAN
enum LeadStatus {
  NEW         // Novo Lead
  CONTACT     // Contato Feito
  PROPOSAL    // Proposta Enviada
  WON         // Ganho (Vira Cliente)
  LOST        // Perdido
}